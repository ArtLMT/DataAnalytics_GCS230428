---
title: "task_1"
author: "LMT"
date: "`r Sys.Date()`"
output: html_document
---

# TASK 1

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(skimr)

library(knitr) # For better table
library(lubridate) # Task 1B test
library(scales)
```

# 1. Reading data

```{r}
df <- read_csv("../data/Web Analytic_Dataset.csv")
# df <- read.csv("../data/Web Analytic_Dataset.csv") # doesn't clean data
df
```

## 1.1 Dimension of the data

```{r}
cat("The dimension of dataset: number of columns", ncol(df), "number of rows: ", nrow((df)))
```

## 1.2 Structure of the dataset

```{r}
str(df) # Structure of dataset
```

```{r}
sapply(df,class)
```

# 1.3 Check for errors:

## 1.3.1 Missing value

```{r}
colSums(is.na(df))
```

## 1.3.2 duplicate value

```{r}
any(duplicated(df))
```

## 1.3.3 Incosistant data type

#### 1.3.3.1 Conversion Rate

The conversion rate type is character, make it hard to analysis as it can't be applied with math. So it will be converted into int However, there was some data that aren't calculate proberly as so small number (\<0.01%) so it needed to be recalculate

```{r}
df_clean_task_one <- df %>%
  mutate(
    Revenue = as.numeric(gsub(",", "", Revenue)),
    Sessions = as.numeric(gsub(",", "", Sessions)),
    `Conversion Rate (%)` = gsub("<", "", `Conversion Rate (%)`),         # Remove < symbol
    `Conversion Rate (%)` = as.numeric(gsub("%", "", `Conversion Rate (%)`)),
    `Bounce Rate` = as.numeric(gsub("%", "", `Bounce Rate`))
  )
```

*Conclusion* : there isn't any errors in this dataset

```{r}
str(df_clean_task_one)
```

## Task 1.A The top three traffic and the revenue of each year

### Top 3 source by Session
Getting the top 3 of each year by Sessions

```{r}
top3_dual <- df_clean_task_one %>%
  group_by(Year, `Source / Medium`) %>%
  summarise(
    Total_Sessions = sum(Sessions, na.rm = TRUE),
    Total_Revenue = sum(Revenue, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(Year) %>%
  slice_max(Total_Sessions, n = 3) %>%
  ungroup()
```


```{r}
# Plot
top3_sessions <- top3_dual %>%
  select(Year, `Source / Medium`, Total_Sessions, Total_Revenue)

ggplot(top3_sessions, aes(x = `Source / Medium`, y = Total_Sessions, fill = `Source / Medium`)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = scales::comma(Total_Sessions)), 
            vjust = -0.5, size = 3.5) +
  facet_wrap(~ Year) +
  labs(
    title = "Top 3 Traffic Sources per Year by Sessions",
    x = "Source / Medium",
    y = "Total Sessions"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(top3_sessions, aes(x = `Source / Medium`, y = Total_Revenue, fill = `Source / Medium`)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = scales::comma(Total_Revenue)), # label hien data len
            vjust = -0.5, size = 3.5) +
  facet_wrap(~ Year) +
  labs(
    title = "Revenue of the Top 3 Traffic Sources per Year by Sessions",
    x = "Source / Medium",
    y = "Total Revenue"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
### Top 3 source by revenue:
```{r}
top3_dual <- df_clean_task_one %>%
  group_by(Year, `Source / Medium`) %>%
  summarise(
    Total_Sessions = sum(Sessions, na.rm = TRUE),
    Total_Revenue = sum(Revenue, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(Year) %>%
  slice_max(Total_Revenue, n = 3) %>%
  ungroup()

top3_revenue <- top3_dual %>%
  select(Year, `Source / Medium`, Total_Sessions, Total_Revenue)

ggplot(top3_revenue , aes(x = `Source / Medium`, y = Total_Revenue, fill = `Source / Medium`)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ Year) +
  geom_text(aes(label = scales::comma(Total_Revenue)), 
            vjust = -0.5, size = 3.5) +
  labs(
    title = "Top 3 Traffic Sources per Year by Revenue",
    x = "Source / Medium",
    y = "Total Sessions"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
### Top 3 revenue of all time
```{r}
top3_revenue_all_time <- df_clean_task_one %>%
  group_by(`Source / Medium`) %>%
  summarise(Total_Revenue = sum(Revenue, na.rm = TRUE), .groups = "drop") %>%
  slice_max(Total_Revenue, n = 3) %>%
  ungroup()

ggplot(top3_revenue_all_time, aes(x = `Source / Medium`, y = Total_Revenue, fill = `Source / Medium`)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = scales::comma(Total_Revenue)), vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Top 3 Traffic Sources by Revenue (All Years)",
    x = "Source / Medium",
    y = "Total Revenue"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}

# Step 1: Summarise the data
summary_table <- df_clean_task_one %>%
  group_by(`Source / Medium`) %>%
  summarise(
    Total_Sessions = sum(Sessions, na.rm = TRUE),
    Total_Revenue = sum(Revenue, na.rm = TRUE),
    .groups = "drop"
  )

# Step 2: Get top 3 by revenue
top3_revenue <- summary_table %>%
  slice_max(Total_Revenue, n = 3) %>%
  mutate(Type = "Top Revenue")

# Step 3: Get top 3 by sessions
top3_sessions <- summary_table %>%
  slice_max(Total_Sessions, n = 3) %>%
  mutate(Type = "Top Sessions")

# Step 4: Combine both tables
top3_combined <- bind_rows(top3_revenue, top3_sessions)

# Optional: Remove duplicates (if a source appears in both)
top3_combined_unique <- top3_combined %>%
  distinct(`Source / Medium`, .keep_all = TRUE)


top3_dual <- df_clean_task_one %>%
  group_by(`Source / Medium`) %>%
  summarise(
    Total_Sessions = sum(Sessions, na.rm = TRUE),
    Total_Revenue = sum(Revenue, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  slice_max(Total_Revenue, n = 3) %>%
  ungroup()

top3_revenue <- top3_combined_unique %>%
  select(`Source / Medium`, Total_Sessions, Total_Revenue)

ggplot(top3_revenue , aes(x = `Source / Medium`, y = Total_Revenue, fill = `Source / Medium`)) +
  geom_col(show.legend = FALSE) +
  scale_y_continuous(labels = comma) +
  geom_text(aes(label = scales::comma(Total_Revenue)), 
            vjust = -0.5, size = 3.5) +
  labs(
    title = "Top 3 Traffic Sources by Revenue",
    x = "Source / Medium",
    y = "Total Revenue"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(top3_revenue , aes(x = `Source / Medium`, y = Total_Sessions, fill = `Source / Medium`)) +
  geom_col(show.legend = FALSE) +
  scale_y_continuous(labels = comma) +
  geom_text(aes(label = scales::comma(Total_Sessions)), 
            vjust = -0.5, size = 3.5) +
  labs(
    title = "Top 3 Traffic Sources by Session",
    x = "Source / Medium",
    y = "Total Sessions"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**Comment:** Based on the analysis of website traffic data for 2019 and 2020, the top three traffic sources by the number of sessions were identified. In 2019, the leading sources were A, B, and E, while in 2020, Source C replaced E.
Throughout both years, Source A consistently performed best, generating the highest number of sessions and the most revenue.
However, while Sources B, C, and E contributed high traffic volumes, they did not generate as much revenue compared to their session counts. This suggests that being in the top 3 traffic sources by sessions does not necessarily mean they bring strong business value.
A striking finding is Source S: although it brought in a relatively small number of sessions, it generated a disproportionately high amount of revenue. This makes Source S a high-value source despite low traffic.

This indicates that Source A was the most effective traffic source overall — both in attracting visitors and generating revenue. Also the S is worth investing more


## Task 1.B

2 case 1 la coi cot source lam device 2 Make up data Chia lam 2 loai Mobile + Desktop \### Task 1B Case 1

giả định mỗi hàng source / medium là 1 device

```{r}
conversion_by_device <- df_clean_task_one %>%
  group_by(Year, `Month of the year`, `Source / Medium`) %>%
  summarise(
    Conversion = `Conversion Rate (%)`,
    Total_Sessions = sum(Sessions, na.rm = TRUE),
    Total_Revenue = sum(Revenue, na.rm = TRUE),
    .groups = "drop"
  )
```
## Task 1.B: Comparative Analysis of Devices and Conversion Rates

This document provides a comparative analysis of the devices used by customers or visitors to access the site and their conversion rates for each year and month, as required for Task 1b. The dataset "Web Analytic_Dataset.csv" is used, where "Source/Medium" is considered as "Devices" per the task specification. The analysis is presented in tables and charts using RStudio and R Markdown.

## Analysis of Devices by Users and New Users

This section analyzes the total users and new users for each device (Source/Medium).

### Table: Total Users and New Users by Device

We summarize the total users and new users per device.

```{r device_summary_table}
device_summary <- df_clean_task_one %>%
  group_by(`Source / Medium`) %>%
  summarise(`Total Users` = sum(Users, na.rm=TRUE),
            `Total New Users` = sum(`New Users`, na.rm=TRUE))

print(device_summary)

# knitr::kable(device_summary, caption = "Total Users and New Users by Device")
```

### Chart: Total Users and New Users by Device

A bar chart visualizes the total users and new users of each device

```{r device_summary_chart, fig.width=10, fig.height=6}
ggplot(device_summary_long, aes(x = `Source / Medium`, y = Count, fill = Type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("Total Users" = "#1f77b4", "Total New Users" = "#2ca02c")) +
  labs(
    title = "Total Users and New Users by Device",
    subtitle = "Grouped by Source / Medium",
    x = "Device (Source / Medium)",
    y = "Number of Users",
    fill = "User Type"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12),
    legend.position = "top"
  )

```

## Analysis of Conversion Rates by Device, Year, and Month

This section analyzes the conversion rates for each device across each year and month.

### Conversion Rate by Device and Year-Month 

```{r}
kable(conversion_by_device, caption = "Conversion Rate by 'Device' (Source/Medium) per Month and Year")
```

There were too many record, with 38 different source / medium. THerefore, only the one with 12 record resemble 12 month are chosen to be analysis

```{r}
ggplot(conversion_by_device, aes(x = factor(`Month of the year`), y = Conversion, fill = `Source / Medium`)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Year) +
  labs(
    title = "Average Conversion Rate by Device per Month and Year",
    x = "Month",
    y = "Conversion Rate (%)",
    fill = "Device"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0))
```
#### 12 month conversion rate 

```{r}
month_coverage <- df_clean_task_one %>%
  group_by(`Source / Medium`) %>%
  summarise(Month_Count = n_distinct(`Month of the year`), .groups = "drop") %>%
  filter(Month_Count == 12)

month_coverage

df_filtered <- df_clean_task_one %>%
  semi_join(month_coverage, by = "Source / Medium") %>%
  mutate(
    Month_Name = factor(
      month.name[as.integer(`Month of the year`)],
      levels = month.name
    ),
    YearMonth = paste(Year, Month_Name, sep = "-")
  ) %>%
  arrange(`Source / Medium`, Year, as.integer(`Month of the year`))

conversion_table <- df_filtered %>%
  select(`Source / Medium`, Year, Month_Name, `Conversion Rate (%)`)


kable(conversion_table, 
      caption = "Conversion Rates, Sessions, and Revenue by Device, Year, and Month",
      col.names = c("Device", "Year", "Month", "Conversion Rate (%)"))
```
Convert the numberic month to words for easier visualization Also check if the proposion rate is too biass to one side, make sure it's acceptable simulate

```{r fig.width=10, fig.height=8}
ggplot(df_filtered, aes(x = YearMonth, y = `Conversion Rate (%)`, group = `Source / Medium`, color = `Source / Medium`)) +
  geom_line(size = 1) +
  geom_point(size = 3) +  # Put point directly on the line
  theme_minimal() +
  labs(
    title = "Conversion Rate by Device Over Time",
    subtitle = "Timeline: September 2019 to August 2020 (Devices with Full 12-Month Coverage)",
    x = "Month-Year",
    y = "Conversion Rate (%)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12),
    legend.position = "top",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid.minor = element_blank()
  )
```
The line chart shows monthly conversion rates for each device over time. Most sources maintained a relatively stable and low conversion rate (under 1%) throughout the 12 months, such as A, B, and F. These sources are more consistent but may lack efficiency in turning users into conversions.

#### Top 5 conversion rate

```{r}
df_filtered <- df_clean_task_one %>%
  mutate(
    Month_Name = factor(
      month.name[as.integer(`Month of the year`)],
      levels = month.name
    ),
    YearMonth = paste(Year, Month_Name, sep = "-")
  ) %>%
  arrange(`Source / Medium`, Year, as.integer(`Month of the year`))

# Calculate average conversion rate per device and select top 5
top_devices <- df_filtered %>%
  group_by(`Source / Medium`) %>%
  summarise(Avg_Conversion_Rate = mean(`Conversion Rate (%)`, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(Avg_Conversion_Rate)) %>%
  slice_head(n = 5)

# Print top 5 devices for verification
print(top_devices)

# Filter data for top 5 devices
df_top5 <- df_filtered %>%
  filter(`Source / Medium` %in% top_devices$`Source / Medium`)


```


```{r fig.width=10, fig.height=8}
ggplot(df_top5, aes(x = YearMonth, y = `Conversion Rate (%)`, group = `Source / Medium`, color = `Source / Medium`)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  theme_minimal() +
  labs(
    title = "Conversion Rate by Top 5 Devices Over Time",
    subtitle = "Timeline: September 2019 to August 2020",
    x = "Month-Year",
    y = "Conversion Rate (%)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12),
    legend.position = "top",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid.minor = element_blank()
  )
```


## Task 1.C Produce an analysis to show the relationship between Bounce rate, Conversion, Transaction, and Revenue. Comments on your findings in terms of how each of the three relates to each other

To do this, using correlation to see the relationship of the field There is Bounce rate - conversion rate, transaction - revenue, bounce rate - transaction Create new table for relation ship data only

```{r}
df_relationship <- df_clean_task_one %>%
  select(`Bounce Rate`, `Conversion Rate (%)`, Revenue, Transactions)

cor_matrix <- round(cor(df_relationship, use = "complete.obs"), 2)

cor_df <- as.data.frame(cor_matrix) %>%
  mutate(Var1 = rownames(.)) %>%
  pivot_longer(cols = -Var1, names_to = "Var2", values_to = "Correlation")

cor_matrix
cor_df
```

```{r}
ggplot(cor_df, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile(color = "white") +
  geom_text(aes(label = Correlation), color = "black", size = 4) +
  scale_fill_gradient2(low = "red", mid = "white", high = "green",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Correlation") +
  labs(title = "Heatmap: Bounce Rate vs Conversion, Transactions, Revenue",
       x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```
##### Transaction vs Revenue

**Comment** WE can clearly see that the relationship between Transactions and revenue is a positive correlation relationship. As the more transactions were made, the more revenue it provide

```{r}
ggplot(df_clean_task_one, aes(x = Transactions, y = Revenue)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "green") +
  labs(title = "Transaction vs Revenue",
       x = "Transaction", y = "Revenue") +
  theme_minimal()
```

##### Conversion rate vs Revenue & Transaction This is the positive correlation relaionship, where the more user do what the website wanted, following the website flow will lead to it's business purpose, which increase the transaction and revenue

```{r}
ggplot(df_clean_task_one, aes(x = `Conversion Rate (%)`, y = Revenue)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "green") +
  labs(title = "Conversion Rate (%) vs Revenue",
       x = "Conversion Rate (%)", y = "Revenue") +
  theme_minimal()

ggplot(df_clean_task_one, aes(x = `Conversion Rate (%)`, y = Transactions)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "green") +
  labs(title = "Conversion Rate (%) vs Transactions",
       x = "Conversion Rate (%)", y = "Transactions") +
  theme_minimal()
```

### Bounce Rate vs Conversion Rate

As for the Bounce Rate and conversion rate, its quite a negative corrolation relationship which is also understandable since if they left the website so quickly, they wouldn't do anything else with the website

```{r}
ggplot(df_clean_task_one, aes(x = `Bounce Rate`, y = `Conversion Rate (%)`)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Bounce Rate vs Conversion Rate",
       x = "Bounce Rate (%)", y = "Conversion Rate (%)") +
  theme_minimal()
```

```{r}
ggplot(df_clean_task_one, aes(x = `Bounce Rate`, y = Transactions)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(title = "Bounce Rate vs Transactions",
       x = "Bounce Rate (%)", y = "Transactions") +
  theme_minimal()

ggplot(df_clean_task_one, aes(x = `Bounce Rate`, y = Revenue)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Bounce Rate vs Revenue",
       x = "Bounce Rate (%)", y = "Revenue") +
  theme_minimal()
```
